<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        canvas {
            border: 1px solid #d3d3d3;
            background-color: #f1f1f1;
        }

        body {
            background-color: black;
        }
    </style>
</head>
<body onload="start()" style="overscroll-behavior: none">
<script>

    /*

    *) choice - 1P, 2P
    *) sounds
    *) splash screen
    *) ball trail
    *)

    */

    // 1 = human vs pc
    // 2 = human vs human
    var players = 1;


    var rightBar;
    var leftBar;
    var ball;
    var level;

    function start() {
        myGameArea.init();
        myGameArea.choosePlayers();
    }

    var myGameArea = {

        canvas: document.createElement("canvas"),

        controller: new controller(),

        init: function () {
            this.canvas.width = 480;
            this.canvas.height = 270;
            this.context = this.canvas.getContext("2d");
            document.body.insertBefore(this.canvas, document.body.childNodes[0]);
            this.frameNo = 0;

        },

        clear: function () {
            this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },

        startGame: function () {

            var width = 10;

            leftBar = new bar(10, myGameArea.canvas.height / 4, "black", 0, 100, true);
            rightBar = new bar(10, myGameArea.canvas.height / 4, "black", myGameArea.canvas.width - width, 100, false);
            ball = new ball(5, "#000000", myGameArea.canvas.width / 2, myGameArea.canvas.height / 2);
            level = new level(myGameArea.canvas.width / 2 - 50, 40, "black", "30px", "Consolas");

            this.interval = setInterval(updateGameArea, 1000 / 60);
        },

        choosePlayers: function () {


            // TODO choose human or computer opponent

            this.startGame();
        },

    };

    function level(x, y, fontColor, size, font) {
        this.levels = [
            {
                computerStrength: 0.35,
                //winningScore: 2
            },
            {
                computerStrength: 0.4,
                //winningScore: 2
            },
            {
                computerStrength: 0.45,
                barShorteningRate: 0.9,
            },
            {
                computerStrength: 0.5,
                barShorteningRate: 0.9,
            },
            {
                computerStrength: 0.55,
                barShorteningRate: 0.85
            },
            {
                computerStrength: 0.6,
                barShorteningRate: 0.85
            },
            {
                computerStrength: 0.65,
                barShorteningRate: 0.8
            },
            {
                computerStrength: 0.70,
                barShorteningRate: 0.7
            },
            {
                computerStrength: 0.75,
                barShorteningRate: 0.7
            },
            {
                computerStrength: 0.80,
                barShorteningRate: 0.7
            }
        ];
        this.assignLevelParameters = function () {
            this.winningScore = this.levels[this.level].winningScore || 5;
            this.computerStrength = this.levels[this.level].computerStrength || 1;
            this.barShorteningRate = this.levels[this.level].barShorteningRate || 1;
        };
        this.level = 0;
        this.wonTheGame = false;
        this.assignLevelParameters();
        this.isAfterLastLevel = function () {
            return this.level >= this.levels.length;
        };
        this.isLastLevel = function () {
            return this.level === this.levels.length - 1;
        };

        this.isEndOfLevel = function (score) {
            return score === this.winningScore;
        };

        this.scoreChanged = function (score, isLeftPlayer) {

            if (this.wonTheGame) {
                return;
            }

            if (this.isEndOfLevel(score)) {

                this.level++;
                rightBar.resetScore();
                leftBar.resetScore();

                rightBar.setOriginalHeight();
                leftBar.setOriginalHeight();

                if (isLeftPlayer) {
                    leftBar.increaseLevelScore();
                } else {
                    rightBar.increaseLevelScore();
                }

                var isHuman = !isLeftPlayer;
                var computerWon = players === 1 && !isHuman;

                if (computerWon) {
                    this.wonTheGame = "You LOST ! ! !";
                    return;
                }

                if (this.isAfterLastLevel()) {
                    if (players === 1) {
                        this.wonTheGame = "You WON ! ! !";
                    } else {

                        if (rightBar.levelScore.value === leftBar.levelScore.value) {
                            return;
                        }

                        if (rightBar.levelScore.value > leftBar.levelScore.value) {
                            this.wonTheGame = "Right WON ! ! !"
                        } else {
                            this.wonTheGame = "Left WON ! ! !";
                        }
                    }

                } else {
                    this.assignLevelParameters();
                }
            }
        };
        this.getLevelLabel = function () {
            return "Level: " + (this.level + 1);
        };
        this.paint = function (paintingContext) {
            paintingContext.font = size + " " + font;
            paintingContext.fillStyle = fontColor;
            if (this.wonTheGame) {
                paintingContext.fillText(this.wonTheGame, x - 40, y);
            } else {
                paintingContext.fillText(this.getLevelLabel(), x, y);
            }

        }
    }

    function ball(radius, color, x, y) {
        this.radius = radius;
        this.color = color;
        this.x = x;
        this.y = y;
        this.dx = 2;
        this.dy = 2;

        this.restart = function () {
            this.x = myGameArea.canvas.width / 2;
            this.y = myGameArea.canvas.height / 2;
            this.dx = 2;
            this.dy = 2;
        };

        this.paint = function (paintingContext) {
            paintingContext.fillStyle = this.color;
            paintingContext.beginPath();
            paintingContext.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
            paintingContext.fill();
        };

        this.move = function () {
            this.x = this.x + this.dx;
            this.y = this.y + this.dy;
        };

        this.collide = function () {

            if (this.x >= myGameArea.canvas.width) {
                this.restart();
                leftBar.increaseScore();
                level.scoreChanged(leftBar.score.value, true);
                leftBar.shorten();
                return;
            }

            if (this.x <= 0) {
                this.restart();
                rightBar.increaseScore();
                level.scoreChanged(rightBar.score.value, false);
                rightBar.shorten();
                return;
            }

            // right bar - always controlled by human
            if (this.x + this.radius >= rightBar.x
                && this.y >= rightBar.y
                && this.y <= rightBar.y + rightBar.height
                && this.dx > 0) {

                this.dx = this.dx * -1;

                if (myGameArea.controller.keys["ArrowUp"] || myGameArea.controller.keys["ArrowDown"]) {
                    this.dx--;
                    this.setDirection();
                }

            }
            // left bar -
            else if (this.x - this.radius <= leftBar.x + leftBar.width
                && this.y >= leftBar.y
                && this.y <= leftBar.y + leftBar.height
                && this.dx < 0) {

                this.dx = this.dx * -1;

                if (players === 2 && (myGameArea.controller.keys["KeyW"] || myGameArea.controller.keys["KeyS"])) {
                    this.dx++;
                    this.setDirection();
                }

            } else if (this.dy < 0
                && this.y - this.radius <= 0) {

                this.dy = this.dy * -1;

            } else if (this.dy > 0
                && this.y + this.radius >= myGameArea.canvas.height) {

                this.dy = this.dy * -1;
                console.log('ball is at bottom', this.y)

            }

        };

        this.setDirection = function () {

            if (Math.random() > 0.8) {

                if (this.dy >= 0) {
                    this.dy = this.dy + 1;

                }
                if (this.dy <= 0) {
                    this.dy = this.dy - 1;
                }
            }

            if (Math.random() > 0.2) {
                if (this.dy > 0 && myGameArea.controller.keys["ArrowUp"]) {
                    this.dy = this.dy * -1;

                }
                if (this.dy < 0 && myGameArea.controller.keys["ArrowDown"]) {
                    this.dy = this.dy * -1;
                }

            }

        }
    }

    function text(size, fontColor, color, x, y) {
        this.value = 0;

        this.paint = function (paintingContext) {
            paintingContext.font = size + " " + fontColor;
            paintingContext.fillStyle = color;
            paintingContext.fillText(this.value, x, y);
        }
    }

    function bar(width, height, color, x, y, isLeft) {
        this.width = width;
        this.height = height;
        this.x = x;
        this.y = y;
        this.step = 5;
        this.originalHeight = height;
        this.lowestYPoint = myGameArea.canvas.height - this.height;
        this.score = new text("30px", "Consolas", "black", isLeft ? x + 10 : x - 20, 40);
        this.levelScore = new text("30px", "Consolas", "black", isLeft ? x + 10 : x - 20, myGameArea.canvas.height - 30);

        this.paint = function (paintingContext) {
            paintingContext.fillStyle = color;
            paintingContext.fillRect(this.x, this.y, this.width, this.height);
            this.score.paint(paintingContext);
            players === 2 && this.levelScore.paint(paintingContext);

        };

        this.goUp = function () {
            if (this.y > this.step) {
                this.y = this.y - this.step;
            }
        };

        this.goDown = function () {
            if (this.y + this.step < this.lowestYPoint) {
                this.y = this.y + this.step;
            }
        };

        this.setDiff = function (diff) {
            var nextY = this.y + diff;
            if (nextY < 0 || nextY > this.lowestYPoint) {
                return;
            }
            this.y = this.y + diff;
        };

        this.shorten = function () {
            this.height = this.height * level.barShorteningRate;
        };

        this.setOriginalHeight = function () {
            this.height = this.originalHeight;
        };

        this.increaseScore = function () {
            this.score.value++;
        };

        this.increaseLevelScore = function () {
            this.levelScore.value++;
        };

        this.resetScore = function () {
            this.score.value = 0;
        };

    }

    function updateGameArea() {

        if (myGameArea.controller.pause) {
            return;
        }

        if (players === 1) {
            moveByComputer();
            moveRightBarByKeyboard();
        } else {
            moveRightBarByKeyboard();
            moveLeftBarByKeyboard();
        }

        ball.collide();
        ball.move();

        myGameArea.clear();

        rightBar.paint(myGameArea.context);
        leftBar.paint(myGameArea.context);
        ball.paint(myGameArea.context);
        level.paint(myGameArea.context);
    }

    function controller() {
        this.keys = {};
        this.pause = false;
        this.lastY = 0;
        var self = this;
        var onkeydown = onkeyup = function (e) {
            e = e || event;
            self.keys[e.code] = e.type === 'keydown';

            if (e.code === 'Space') {
                self.pause = !self.pause;
            }
        };

        var touchstart = function (e) {
            var touch = e.touches[0];
            self.lastY = touch.clientY;
        };
        var touchmove = function (e) {

            e.preventDefault();
            e.stopPropagation();
            var touch = e.touches[0];
            var diff = self.lastY - touch.clientY;
            self.lastY = touch.clientY;
            rightBar.setDiff(diff * -1);

        };

        document.addEventListener('keydown', onkeydown);
        document.addEventListener('onkeyup', onkeyup);
        document.addEventListener('touchstart', touchstart);
        document.addEventListener("touchmove", touchmove);

    }


    function moveRightBarByKeyboard() {

        if (myGameArea.controller.keys["ArrowUp"]) {
            rightBar.goUp();
        }
        if (myGameArea.controller.keys["ArrowDown"]) {
            rightBar.goDown();
        }

    }

    function moveLeftBarByKeyboard() {

        if (myGameArea.controller.keys["KeyW"]) {
            leftBar.goUp();
        }
        if (myGameArea.controller.keys["KeyS"]) {
            leftBar.goDown();
        }

    }

    function moveByComputer() {

        if (ball.dx > 0) {
            return;
        }

        if (Math.random() > level.computerStrength) {
            return;
        }

        if (ball.y > (leftBar.y + leftBar.height / 2)) {
            leftBar.goDown();
        }

        if (ball.y < (leftBar.y + leftBar.height / 2)) {
            leftBar.goUp();
        }

    }


</script>
<br/>
</body>
</html>
